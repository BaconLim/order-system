<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åƒè‘‰ç´ é£Ÿä¾¿ç•¶ - ç·šä¸Šé»é¤</title>
    <!-- å¼•å…¥ Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ LINE LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 50; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-[#f3f8f2] pb-24 text-gray-800"> <!-- èƒŒæ™¯æ”¹ç‚ºæ¥µæ·¡çš„ç¶ è‰² -->

    <div id="app">
        
        <!-- å…¨å±€è¼‰å…¥é®ç½© -->
        <div v-if="isLoading" class="loading-overlay">
            <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-[#06C755] mb-4"></div>
            <p class="text-gray-600 font-medium">{{ loadingText }}</p>
        </div>

        <!-- é ‚éƒ¨å°èˆª -->
        <div class="bg-white sticky top-0 z-10 shadow-sm px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <!-- æ–°å¢ï¼šç´ é£Ÿè‘‰å­åœ–ç¤º -->
                <div class="bg-green-100 p-1.5 rounded-full">
                    <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 24 24"><path d="M17,8C8,10,5.9,16.17,3.82,21.34L5.71,22l1-2.3A4.49,4.49,0,0,0,8,20C19,20,22,3,22,3,21,5,14,5.25,9,6.25S2,11.5,2,13.5a6.22,6.22,0,0,0,1.75,3.75C7,13,15,7,17,8Z"/></svg>
                </div>
                <h1 class="text-lg font-bold text-gray-800 tracking-wide">åƒè‘‰ç´ é£Ÿä¾¿ç•¶</h1>
            </div>
            <!-- é¡¯ç¤ºç™»å…¥è€…è³‡è¨Š -->
            <div class="flex items-center text-xs text-gray-500 bg-gray-50 px-2 py-1 rounded-full border border-gray-100">
                <img :src="profile.pictureUrl || 'https://cdn-icons-png.flaticon.com/512/847/847969.png'" class="w-5 h-5 rounded-full mr-2 object-cover border border-gray-200">
                <span class="max-w-[80px] truncate">{{ profile.displayName || 'è¨ªå®¢' }}</span>
            </div>
        </div>

        <!-- å•†åº—å½¢è±¡åœ– -->
        <div class="relative h-48 bg-gray-300 overflow-hidden">
            <!-- æ›æˆæ›´å¼·èª¿æ–°é®®è”¬èœçš„åœ–ç‰‡ -->
            <img src="https://images.unsplash.com/photo-1490645935967-10de6ba17061?auto=format&fit=crop&q=80&w=800&h=400" class="w-full h-full object-cover">
            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-green-900/80 to-transparent p-4 pt-12">
                <div class="flex items-end justify-between text-white">
                    <div>
                        <p class="text-sm font-medium opacity-90 mb-1 flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            å¤©ç„¶é£Ÿæãƒ»ç´”ç´ ãƒ»å¥åº·
                        </p>
                        <div class="flex items-center text-xs bg-white/20 backdrop-blur-sm px-2 py-1 rounded-lg w-fit border border-white/30">
                            <span class="w-2 h-2 bg-green-400 rounded-full mr-1 animate-pulse"></span>
                            ç‡Ÿæ¥­ä¸­ 10:00 - 20:00
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ­¥é©Ÿ 1: èœå–®åˆ—è¡¨ -->
        <div v-if="step === 1" class="p-4 space-y-4 animate-fade-in">
            <div class="flex items-center justify-between border-l-4 border-[#06C755] pl-3 py-1">
                <h2 class="font-bold text-lg text-gray-800">ç²¾é¸ç´ é£Ÿé¤é»</h2>
                <span class="text-xs text-green-600 bg-green-50 px-2 py-1 rounded-full">å¥åº·ç„¡è² æ“”</span>
            </div>
            
            <div v-for="item in menu" :key="item.id" class="bg-white rounded-xl p-3 shadow-sm border border-gray-100 flex gap-3 transition-all hover:shadow-md">
                <!-- åœ–ç‰‡å€å¡Š -->
                <div class="w-24 h-24 rounded-lg bg-gray-50 overflow-hidden shrink-0 relative">
                    <img :src="item.image" class="w-full h-full object-cover" loading="lazy">
                </div>

                <!-- è³‡è¨Šå€å¡Š -->
                <div class="flex-1 flex flex-col justify-between py-0.5">
                    <div>
                        <h3 class="font-bold text-gray-800 text-[15px] leading-tight mb-1">{{ item.name }}</h3>
                        <span class="inline-block text-[10px] text-green-700 bg-green-50 px-2 py-0.5 rounded-full border border-green-100">{{ item.category }}</span>
                    </div>
                    
                    <div class="flex justify-between items-end">
                        <span class="text-lg font-bold text-gray-900">${{ item.price }}</span>
                        
                        <!-- åŠ æ¸›æŒ‰éˆ•æ§åˆ¶ -->
                        <div class="flex items-center bg-gray-50 rounded-lg p-1">
                            <button 
                                v-if="cart[item.id] > 0" 
                                @click="updateCart(item.id, -1)" 
                                class="w-7 h-7 rounded-md bg-white border border-gray-200 text-gray-600 flex items-center justify-center active:scale-95 transition-transform"
                            >
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M20 12H4"/></svg>
                            </button>
                            
                            <span v-if="cart[item.id] > 0" class="font-bold text-gray-800 min-w-[1.5rem] text-center text-sm">{{ cart[item.id] }}</span>
                            
                            <button 
                                @click="updateCart(item.id, 1)" 
                                class="w-7 h-7 rounded-md bg-[#06C755] text-white flex items-center justify-center shadow-sm active:scale-95 transition-transform"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ­¥é©Ÿ 2: çµå¸³è¡¨å–® -->
        <div v-if="step === 2" class="p-4 space-y-4 animate-fade-in">
            <!-- è¿”å›æŒ‰éˆ• -->
            <button @click="step = 1" class="text-sm text-gray-500 flex items-center mb-2 px-2 py-1 rounded hover:bg-white hover:shadow-sm transition-all">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                è¿”å›ä¿®æ”¹é¤é»
            </button>

            <!-- è¨‚å–®æ‘˜è¦ -->
            <div class="bg-white rounded-xl p-5 shadow-sm border border-green-50">
                <h3 class="font-bold text-gray-800 border-b border-gray-100 pb-3 mb-3 flex justify-between items-center">
                    è¨‚å–®å…§å®¹
                    <span class="text-xs font-normal text-green-700 bg-green-50 px-2 py-1 rounded">å…± {{ totalQty }} é …</span>
                </h3>
                <div class="space-y-2 max-h-[200px] overflow-y-auto hide-scrollbar">
                    <div v-for="(qty, id) in cart" :key="id" class="flex justify-between text-sm py-1">
                        <div class="flex items-center">
                            <span class="w-5 h-5 flex items-center justify-center bg-gray-100 text-gray-600 text-[10px] rounded mr-2">{{ qty }}</span>
                            <span class="text-gray-700">{{ getMenuItem(id).name }}</span>
                        </div>
                        <span class="font-medium text-gray-900">${{ getMenuItem(id).price * qty }}</span>
                    </div>
                </div>
                <div class="flex justify-between pt-3 mt-2 border-t border-dashed border-gray-200 font-bold text-lg text-[#06C755]">
                    <span>ç¸½é‡‘é¡</span>
                    <span>${{ totalPrice }}</span>
                </div>
            </div>

            <!-- å¡«å¯«è³‡æ–™è¡¨å–® -->
            <form @submit.prevent="submitOrder" class="bg-white rounded-xl p-5 shadow-sm space-y-4">
                <div class="flex items-center mb-2">
                    <span class="w-1 h-5 bg-[#06C755] mr-2 rounded-full"></span>
                    <h3 class="font-bold text-gray-800">å¤–é€è³‡è¨Š</h3>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">å–®ä½ / å…¬å¸åç¨± <span class="text-red-500">*</span></label>
                        <input v-model="form.unit" type="text" required placeholder="ä¾‹å¦‚ï¼šå°ç©é›» F12" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-[#06C755] focus:border-transparent outline-none transition-all text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">è¯çµ¡é›»è©± <span class="text-red-500">*</span></label>
                        <input v-model="form.phone" type="tel" required placeholder="09xx-xxx-xxx" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-[#06C755] focus:border-transparent outline-none transition-all text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">å¤–é€åœ°å€ <span class="text-red-500">*</span></label>
                        <input v-model="form.address" type="text" required placeholder="è«‹è¼¸å…¥å®Œæ•´åœ°å€" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-[#06C755] focus:border-transparent outline-none transition-all text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">é è¨ˆé€é”æ™‚é–“ <span class="text-red-500">*</span></label>
                        <input v-model="form.time" type="time" required class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-[#06C755] focus:border-transparent outline-none transition-all text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">å‚™è¨» (é¸å¡«)</label>
                        <textarea v-model="form.remark" placeholder="ä¾‹å¦‚ï¼šè‡ªå‚™é¤å…·ã€ä¸åŠ èª¿æ–™..." rows="2" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-[#06C755] focus:border-transparent outline-none transition-all text-sm resize-none"></textarea>
                    </div>
                </div>
            </form>
        </div>

        <!-- æ­¥é©Ÿ 3: æˆåŠŸç•«é¢ -->
        <div v-if="step === 3" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center p-6 text-center animate-fade-in">
            <div class="w-24 h-24 bg-green-50 rounded-full flex items-center justify-center mb-6 shadow-sm border border-green-100">
                <svg class="w-12 h-12 text-[#06C755]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"></path></svg>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">è¨‚å–®å·²é€å‡ºï¼</h2>
            <p class="text-gray-500 mb-8 leading-relaxed">æ„Ÿè¬æ‚¨é¸æ“‡åƒè‘‰ç´ é£Ÿ<br>æˆ‘å€‘æ­£åœ¨ç”¨å¿ƒæº–å‚™æ‚¨çš„é¤é» ğŸŒ±</p>
            
            <div class="w-full max-w-xs space-y-3">
                <button @click="closeLiff" class="w-full bg-[#06C755] hover:bg-[#05b34c] text-white py-3.5 rounded-xl font-bold shadow-lg shadow-green-200 transition-all">
                    é—œé–‰è¦–çª—
                </button>
                <button @click="resetForm" class="w-full bg-white text-gray-500 py-3 rounded-xl font-medium hover:bg-gray-50 transition-colors border border-gray-100">
                    å†é»ä¸€å–®
                </button>
            </div>
        </div>

        <!-- åº•éƒ¨çµå¸³æŒ‰éˆ• (åªåœ¨æ­¥é©Ÿ1é¡¯ç¤º) -->
        <div v-if="step === 1 && totalQty > 0" class="fixed bottom-0 left-0 right-0 bg-white p-4 border-t border-gray-100 shadow-[0_-4px_20px_rgba(0,0,0,0.05)] z-20 pb-safe">
            <div class="flex justify-between items-center mb-2 px-1">
                <span class="text-sm font-medium text-gray-500">å·²é¸ <strong class="text-[#06C755]">{{ totalQty }}</strong> é …</span>
                <span class="text-xl font-bold text-gray-900">${{ totalPrice }}</span>
            </div>
            <button @click="step = 2" class="w-full bg-[#06C755] text-white font-bold text-lg py-3.5 rounded-xl shadow-lg shadow-green-200 active:scale-[0.98] transition-all flex items-center justify-center">
                å»å¡«å¯«è³‡æ–™ <span class="ml-2 text-xl">â†’</span>
            </button>
        </div>

        <!-- åº•éƒ¨æäº¤æŒ‰éˆ• (åªåœ¨æ­¥é©Ÿ2é¡¯ç¤º) -->
        <div v-if="step === 2" class="fixed bottom-0 left-0 right-0 bg-white p-4 border-t border-gray-100 shadow-[0_-4px_20px_rgba(0,0,0,0.05)] z-20 pb-safe">
            <div class="text-center mb-2 text-xs text-gray-400">ç¢ºèªç„¡èª¤å¾Œè«‹æŒ‰ä¸‹é€å‡º</div>
            <button @click="submitOrder" class="w-full bg-[#06C755] text-white font-bold text-lg py-3.5 rounded-xl shadow-lg shadow-green-200 active:scale-[0.98] transition-all">
                ç¢ºèªé€å‡ºè¨‚å–® â€¢ ${{ totalPrice }}
            </button>
        </div>

    </div>

    <script>
        const CONFIG = {
            LIFF_ID: '2008669562-G6If46m2', 
            API_URL: 'https://script.google.com/macros/s/AKfycbxiag2vvebq1Fm6501meAUYXkE1IKZB-1CKzZMScB1WBWqaLBvwqxssEEXyixD8Capr/exec'
        };

        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const step = ref(1);
                const isLoading = ref(true);
                const loadingText = ref('æ­£åœ¨æº–å‚™ç´ é£Ÿèœå–®...');
                const cart = ref({});
                const profile = ref({ displayName: '', pictureUrl: '' });
                const orderId = ref('');
                
                const form = ref({
                    unit: '',
                    phone: '',
                    address: '',
                    time: '',
                    remark: ''
                });

                // æ›´æ–°å¾Œçš„èœå–®åœ–ç‰‡ (ä½¿ç”¨ Unsplash ä¸Šçœ‹èµ·ä¾†åƒç´ é£Ÿçš„åœ–ç‰‡)
                const menu = ref([
                    { id: 1, name: "ç™½é£¯ä¾¿ç•¶", price: 80, category: "ä¾¿ç•¶", image: "https://images.unsplash.com/photo-1546069901-ba9599a7e63c?auto=format&fit=crop&q=80&w=300" }, // ç¶ è‰²è”¬èœæ²™æ‹‰ç¢—é¢¨æ ¼
                    { id: 2, name: "äº”ç©€é£¯ä¾¿ç•¶", price: 80, category: "ä¾¿ç•¶", image: "https://images.unsplash.com/photo-1511690656952-34342d5c2895?auto=format&fit=crop&q=80&w=300" }, // ç©€ç‰©èˆ‡è”¬èœ
                    { id: 3, name: "å£½å¸ä¾¿ç•¶", price: 80, category: "ä¾¿ç•¶", image: "https://images.unsplash.com/photo-1611143669185-af224c5e3252?auto=format&fit=crop&q=80&w=300" }, // å£½å¸ (çœ‹èµ·ä¾†åƒå°é»ƒç“œå·)
                    { id: 4, name: "ç±³ç²‰ä¾¿ç•¶", price: 80, category: "ä¾¿ç•¶", image: "https://images.unsplash.com/photo-1559314809-0d155014e29e?auto=format&fit=crop&q=80&w=300" }, // ç‚’ç±³ç²‰é¢¨æ ¼
                    { id: 5, name: "ç‚’é£¯ä¾¿ç•¶", price: 80, category: "ä¾¿ç•¶", image: "https://images.unsplash.com/photo-1603133872878-684f208fb74b?auto=format&fit=crop&q=80&w=300" }, // ç‚’é£¯
                    { id: 6, name: "ç‚’éºµä¾¿ç•¶", price: 80, category: "ä¾¿ç•¶", image: "https://images.unsplash.com/photo-1585032226651-759b368d7246?auto=format&fit=crop&q=80&w=300" }, // ç‚’éºµ
                    { id: 7, name: "ç¢—ç²¿ä¾¿ç•¶", price: 80, category: "ä¾¿ç•¶", image: "https://images.unsplash.com/photo-1541696432-82c6da8ce7ea?auto=format&fit=crop&q=80&w=300" }, // è’¸é£Ÿæ„è±¡
                    { id: 8, name: "å†°ç³–ç™½æœ¨è€³", price: 25, category: "ç”œé»", image: "https://images.unsplash.com/photo-1541781777631-fa95371aad95?auto=format&fit=crop&q=80&w=300" }, // ç”œæ¹¯
                    { id: 9, name: "éº»è¾£è±†è…æ¹¯", price: 40, category: "æ¹¯å“", image: "https://images.unsplash.com/photo-1547592180-85f173990554?auto=format&fit=crop&q=80&w=300" }, // è±†è…æ¹¯
                    { id: 10, name: "ç•¶æ­¸æ¹¯", price: 40, category: "æ¹¯å“", image: "https://images.unsplash.com/photo-1594221708779-94832f4320d1?auto=format&fit=crop&q=80&w=300" }, // ä¸­è—¥æ¹¯
                    { id: 11, name: "å‘³å™Œæ¹¯", price: 30, category: "æ¹¯å“", image: "https://images.unsplash.com/photo-1547592166-23acbe54099c?auto=format&fit=crop&q=80&w=300" }  // å‘³å™Œæ¹¯
                ]);

                const initLiff = async () => {
                    try {
                        await liff.init({ liffId: CONFIG.LIFF_ID });
                        if (liff.isLoggedIn()) {
                            const p = await liff.getProfile();
                            profile.value = p;
                        } else {
                            console.log('ä½¿ç”¨è€…æœªç™»å…¥ï¼Œä»¥è¨ªå®¢èº«åˆ†ç¹¼çºŒ');
                            profile.value = { displayName: 'è¨ªå®¢', pictureUrl: '' };
                        }
                    } catch (err) {
                        console.error('LIFF åˆå§‹åŒ–å¤±æ•—', err);
                        profile.value = { displayName: 'è¨ªå®¢', pictureUrl: '' };
                    } finally {
                        isLoading.value = false;
                    }
                };

                onMounted(() => {
                    initLiff();
                });

                const totalQty = computed(() => Object.values(cart.value).reduce((a, b) => a + b, 0));
                
                const totalPrice = computed(() => {
                    return Object.entries(cart.value).reduce((total, [id, qty]) => {
                        const item = menu.value.find(i => i.id == id);
                        return total + (item ? item.price * qty : 0);
                    }, 0);
                });

                const getMenuItem = (id) => menu.value.find(i => i.id == id);

                const updateCart = (id, delta) => {
                    const current = cart.value[id] || 0;
                    const next = Math.max(0, current + delta);
                    if (next === 0) delete cart.value[id];
                    else cart.value[id] = next;
                };

                const submitOrder = async () => {
                    if (!form.value.unit || !form.value.phone || !form.value.address || !form.value.time) {
                        alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ (*) å–”ï¼');
                        return;
                    }

                    isLoading.value = true;
                    loadingText.value = 'æ­£åœ¨å‚³é€è¨‚å–®...';

                    const items = Object.entries(cart.value).map(([id, qty]) => {
                        const item = getMenuItem(id);
                        return { name: item.name, qty: qty, price: item.price };
                    });

                    const payload = {
                        ...form.value,
                        name: profile.value.displayName || 'è¨ªå®¢',
                        items: items,
                        totalPrice: totalPrice.value
                    };

                    try {
                        await fetch(CONFIG.API_URL, {
                            method: 'POST',
                            mode: 'no-cors', 
                            headers: { 'Content-Type': 'text/plain' },
                            body: JSON.stringify(payload)
                        });
                        
                        setTimeout(() => {
                            step.value = 3;
                            isLoading.value = false;
                        }, 800);

                    } catch (err) {
                        alert('ç¶²è·¯é€£ç·šä¼¼ä¹æœ‰å•é¡Œï¼Œè«‹æª¢æŸ¥ç¶²è·¯å¾Œé‡è©¦ã€‚');
                        isLoading.value = false;
                    }
                };

                const resetForm = () => {
                    cart.value = {};
                    step.value = 1;
                    form.value.remark = ''; 
                };

                const closeLiff = () => {
                    if (liff.isInClient()) {
                        liff.closeWindow();
                    } else {
                        alert('æ‚¨å¯ä»¥ç›´æ¥é—œé–‰æ­¤è¦–çª—');
                    }
                };

                return {
                    step, isLoading, loadingText, cart, profile, form, menu,
                    totalQty, totalPrice,
                    updateCart, submitOrder, closeLiff, getMenuItem, resetForm
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
